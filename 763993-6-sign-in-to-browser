# HG changeset patch
# Parent 73a82b326d792ffcc82e24fbf3313c19593cd7a9
try: -b do -p all -u all -t none

diff --git a/browser/base/content/browser-id-signIn.html b/browser/base/content/browser-id-signIn.html
new file mode 100644
--- /dev/null
+++ b/browser/base/content/browser-id-signIn.html
@@ -0,0 +1,152 @@
+<html>
+  <head>
+    <title>Sign In</title>
+    <link href="https://firefoxos.persona.org/production/en/browserid.css" rel="stylesheet" type="text/css"/>
+    <style type="text/css">
+      .hidden {display: none;}
+    </style>
+  </head>
+  <body>
+
+    <!-- create a persona account or sign in with an existing one -->
+    <div id='wrapper'>
+      <div id="hAlign" class="display_always" style="display: block;">
+        <div id='vAlign' style='height: 343px;'>
+
+            <form id="signUpForm" class="cf authform">
+             <div id='sign-in-box'>
+             <h1 id="title">Sign In To Your Browser</h1>
+             <ul>
+               <li>
+                 <label>To sign in with Persona, please enter your email address.</label>
+                 <input type='text' id='email'/>
+               </li>
+  
+               <li id='password-entry' class='hidden'>
+                 <label id='password-old' class='hidden'>Password</label>
+                 <label id='password-new' class='hidden'>
+                   Your email address is new to us. 
+                   Please create a password to use with Persona.
+                 </label>
+                 <input type='password' id='password' autocomplete='off'/>
+               </li>   
+              </ul>
+
+              <div class='submit cf forminputs start'>
+                <button id='next'>Next</button>
+              </div>
+              <div class='submit cf forminputs'>
+                <button id='signIn' class='hidden'>Sign In</button>
+                <button id='create' class='hidden'>Create Account</button>
+              </div>
+              </div>
+
+              <div id='signed-in-box' class='hidden'>
+                <h1>Great Success!</h1> 
+                <p>You are signed in to your browser with Persona.</p>
+                <p>You may close this tab now.</p>
+              </div>
+            </form>
+
+       </div>
+      </div>
+    </div>
+
+
+    <script type="text/javascript;version=1.8">
+      // XXX make lazy
+      Components.utils.import('resource://gre/modules/identity/IdentityService.jsm');
+
+      let origin = 'https://firefox.com';
+      let email_input = document.getElementById('email');
+      let password_input = document.getElementById('password');
+      let next_button = document.getElementById('next');
+      let signin_button = document.getElementById('signIn');
+      let create_button = document.getElementById('create');
+
+      /**
+       * User enters email and clicks Next.  Check for existing account.
+       * If there is one, move on to 'signin'.  Otherwise move on to 
+       * 'create'.
+       */
+      next_button.addEventListener('click', function(evt) {
+        evt.preventDefault();
+        let email = email_input.value;
+        //disable('email');
+        hide('next');
+
+        IdentityService.accountExists({email:email}, function(info) {
+          console.log(info);
+          show('password-entry');
+          if (info.state === 'unknown') {
+            hide('password-old');
+            show('password-new');
+            show('create');
+          } else {
+            hide('password-new');
+            show('password-old');
+            show('signIn');
+          }
+        });
+      });
+
+      /**
+       * User with an existing account enters password and clicks Sign In.
+       * Move on to yay.
+       */
+      signin_button.addEventListener('click', function(evt) {
+        evt.preventDefault();
+        IdentityService.signIn({
+          email: email_input.value,
+          password: password_input.value,
+          origin: origin,
+          allowUnverified: true}, 
+          yay
+        );
+      });
+
+      /**
+       * User enters a password and clicks Create Account.
+       * Move on to yay.
+       */
+      create_button.addEventListener('click', function(evt) {
+        evt.preventDefault();
+        IdentityService.createAccount({
+          email: email_input.value,
+          password: password_input.value,
+          origin: origin,
+          allowUnverified: true}, 
+          yay
+        );
+      });
+
+      /**
+       * Completing either 'signin' or 'create', we check to see if a 
+       * valid assertion was returned.  If so, Great success!  If not,
+       * start again and get an email.
+       */
+      function yay(assertion) {
+        if (assertion) {
+          show('signed-in-box');
+          hide('sign-in-box');
+          console.log("got assertion - hid forms");
+        } else {
+          hide('signed-in-box');
+          show('sign-in-box');
+          hide('password-entry');
+          show('email');
+          show('next');
+        }
+      }
+
+      function show(id) {
+        document.getElementById(id).classList.remove('hidden');
+      }
+
+      function hide(id) {
+        document.getElementById(id).classList.add('hidden');
+      }
+
+    </script>
+  </body>
+</html>
diff --git a/browser/base/jar.mn b/browser/base/jar.mn
--- a/browser/base/jar.mn
+++ b/browser/base/jar.mn
@@ -57,16 +57,17 @@ browser.jar:
         content/browser/aboutSocialError.xhtml        (content/aboutSocialError.xhtml)
 *       content/browser/browser.css                   (content/browser.css)
 *       content/browser/browser.js                    (content/browser.js)
 *       content/browser/browser.xul                   (content/browser.xul)
 *       content/browser/browser-tabPreviews.xml       (content/browser-tabPreviews.xml)
 *       content/browser/chatWindow.xul                (content/chatWindow.xul)
         content/browser/content.js                    (content/content.js)
         content/browser/identity-framescript.js       (content/identity-framescript.js)
+        content/browser/browser-id-signIn.html        (content/browser-id-signIn.html)
         content/browser/newtab/newTab.xul             (content/newtab/newTab.xul)
 *       content/browser/newtab/newTab.js              (content/newtab/newTab.js)
         content/browser/newtab/newTab.css             (content/newtab/newTab.css)
 *       content/browser/pageinfo/pageInfo.xul         (content/pageinfo/pageInfo.xul)
         content/browser/pageinfo/pageInfo.js          (content/pageinfo/pageInfo.js)
         content/browser/pageinfo/pageInfo.css         (content/pageinfo/pageInfo.css)
         content/browser/pageinfo/pageInfo.xml         (content/pageinfo/pageInfo.xml)
         content/browser/pageinfo/feeds.js             (content/pageinfo/feeds.js)
diff --git a/browser/modules/SignInToWebsite.jsm b/browser/modules/SignInToWebsite.jsm
--- a/browser/modules/SignInToWebsite.jsm
+++ b/browser/modules/SignInToWebsite.jsm
@@ -1,15 +1,15 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this file,
  * You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
-// This is only applied to the identity frame when it is created; 
+// This is only applied to the identity frame when it is created;
 // it's not a traditional frame script.
 this.EXPORTED_SYMBOLS = ['SignInToWebsiteUX', 'HostFrame', 'Pipe'];
 
 const Cc = Components.classes;
 const Ci = Components.interfaces;
 const Cu = Components.utils;
 
 Cu.import("resource://gre/modules/Services.jsm");
@@ -60,17 +60,17 @@ function sizePanelToContent(iframe) {
   let computedWidth = parseInt(cs.marginLeft) + body.offsetWidth + parseInt(cs.marginRight);
   let width = Math.max(computedWidth, PANEL_MIN_WIDTH);
 
   // The panel can only resize vertically; otherwise, we would have to
   // compensate for leftward or rightward shifts here
   iframe.style.height = height + "px";
   iframe.style.width = width + "px";
  }
- 
+
 function ResizeWatcher(iframe) {
   this._mutationObserver = null;
   this._iframe = iframe;
   this.start();
 }
 
 // XXX why this no worky?
 ResizeWatcher.prototype = {
@@ -111,17 +111,26 @@ ResizeWatcher.prototype = {
   }
 };
 
 /**
  * Return the chrome window and <browser> for the given outer window ID.
  */
 function getUIForWindowID(aWindowID) {
   // XXX b2g and desktop have different kinds of window ids
-  let outerWindowID = aWindowID.split("-")[0];
+  logger.log("calling with aWindowID=", aWindowID);
+  let outerWindowID;
+  // XXX super atrocious hack for the moment
+  if (typeof aWindowID === 'number') {
+    // it's just a window id
+    outerWindowID = aWindowID;
+  } else {
+    // it's id-uuid
+    outerWindowID = parseInt(aWindowID.split("-")[0], 10);
+  }
   let content = Services.wm.getOuterWindowWithId(outerWindowID);
 
   if (content) {
     let browser = content.QueryInterface(Ci.nsIInterfaceRequestor)
                          .getInterface(Ci.nsIWebNavigation)
                          .QueryInterface(Ci.nsIDocShell).chromeEventHandler;
     let chromeWin = browser.ownerDocument.defaultView;
 
@@ -178,18 +187,18 @@ HostFrame.prototype = {
       logger.error("No callback was given to getIframe");
     }
   },
 
   cleanUp: function HostFrame_cleanUp() {
     if (this._resizeWatcher) {
       this._resizeWatcher.stop();
     }
-  }, 
- 
+  },
+
   _createIframe: function HostFrame_createIframe(aOptions) {
     let hiddenDoc = Services.appShell.hiddenDOMWindow.document;
     this._iframe = hiddenDoc.createElementNS('http://www.w3.org/1999/xhtml', 'iframe');
 
     //this._iframe.setAttribute('mozbrowser', true);
     this._iframe.setAttribute('mozframetype', 'content');
     this._iframe.setAttribute('id', 'persona-host-frame');
     this._iframe.setAttribute('src', aOptions.src);
@@ -257,27 +266,30 @@ Pipe.prototype = {
     Services.obs.notifyObservers(subject, 'identity-delegate-ui-close', null);
 
     if (typeof this.options.onComplete === 'function') {
       this.options.onComplete();
     }
   },
 
   _delegateLoaded: function pipe__delegateLoaded() {
+    logger.log("controller heard delegate loaded; sending", this.options.message);
     this.mm.sendAsyncMessage(this.options.message, this.options.rpOptions);
     // XXX maybe here ??
     //this.resizer = new ResizeWatcher(); etc.
   },
 
   _delegateComplete: function pipe__delegateComplete() {
+    logger.log("controller heard delegate complete");
     this._close();
   },
 
   _serviceDoMethod: function pipe__doMethod(aMethodOptions) {
     let message = aMethodOptions.json;
+    logger.log("controller heard service do method:", message);
     if (typeof message === 'string') {
       try {
         message = JSON.parse(message);
       } catch (err) {
         logger.error('Bad json message: ' + message);
         return;
       }
     }
@@ -306,45 +318,58 @@ Pipe.prototype = {
 this.SignInToWebsiteUX = {
   init: function SignInToWebsiteUX_init(pipeConstructor) {
     this.PipeConstructor = pipeConstructor || Pipe;
     this.contexts = {};
     Services.obs.addObserver(this, 'identity-controller-watch', false);
     Services.obs.addObserver(this, 'identity-controller-request', false);
     Services.obs.addObserver(this, 'identity-controller-logout', false);
     Services.obs.addObserver(this, 'identity-controller-canceled', false);
+
+    Services.obs.addObserver(this, 'identity-controller-getIdentity', false);
+    Services.obs.addObserver(this, 'identity-controller-signIn', false);
+    Services.obs.addObserver(this, 'identity-controller-signOut', false);
+    Services.obs.addObserver(this, 'identity-controller-accountExists', false);
+    Services.obs.addObserver(this, 'identity-controller-createAccount', false);
   },
 
   uninit: function SignInToWebsiteUX_uninit() {
     Services.obs.removeObserver(this, 'identity-controller-watch');
     Services.obs.removeObserver(this, 'identity-controller-request');
     Services.obs.removeObserver(this, 'identity-controller-logout');
     Services.obs.removeObserver(this, 'identity-controller-canceled');
+
+    Services.obs.removeObserver(this, 'identity-controller-getIdentity');
+    Services.obs.removeObserver(this, 'identity-controller-signIn');
+    Services.obs.removeObserver(this, 'identity-controller-signOut');
+    Services.obs.removeObserver(this, 'identity-controller-accountExists');
+    Services.obs.removeObserver(this, 'identity-controller-createAccount');
   },
 
   observe: function SignInToWebsiteUX_observe(aSubject, aTopic, aData) {
     logger.log('controller observed:', aTopic);
+    logger.log('message data:', aData);
     // XXX need to detect page unload of any of our flows
     // XXX we get strings from xul, and objects from elsewhere
     let rpOptions = {};
     if (aSubject) {
       if (aSubject.wrappedJSObject) {
         rpOptions = aSubject.wrappedJSObject;
       } else {
         rpOptions = {id: aSubject.QueryInterface(Ci.nsISupportsString).data};
       }
     }
     if (!rpOptions.id) {
       logger.error('Got a message with no RP id');
       return;
      }
- 
+
     let rpId = rpOptions.id;
     let UI = getUIForWindowID(rpId);
- 
+
     let options = {
       id: rpOptions.id,
       rpOptions: rpOptions
     };
 
     switch (aTopic) {
       case 'identity-controller-watch':
         this.doWatch(options);
@@ -353,66 +378,106 @@ this.SignInToWebsiteUX = {
       case 'identity-controller-request':
         this.doRequest(options);
         break;
 
       case 'identity-controller-logout':
         this.doLogout(options);
         break;
 
+      case 'identity-controller-getIdentity':
+        this.doGetIdentity(options);
+        break;
+
+      case 'identity-controller-signIn':
+        this.doSignIn(options);
+        break;
+
+      case 'identity-controller-signOut':
+        this.doSignOut(options);
+        break;
+
+      case 'identity-controller-accountExists':
+        this.doAccountExists(options);
+        break;
+
+      case 'identity-controller-createAccount':
+        this.doCreateAccount(options);
+        break;
+
       default:
         logger.error('SignInToWebsiteUX', 'Unknown observer notification:', aTopic);
         break;
      }
    },
- 
+
   serviceDoMethod: function SignInToWebsiteUX_doMethod(aMessage, aId) {
     logger.log('serviceDoMethod received:', aMessage);
     switch (aMessage.method) {
       case 'ready':
         IdentityService.doReady(aId);
         break;
- 
+
       case 'login':
         if (aMessage._internalParams) {
           IdentityService.doLogin(aId, aMessage.assertion, aMessage._internalParams);
         } else {
           IdentityService.doLogin(aId, aMessage.assertion);
         }
         break;
- 
+
       case 'logout':
         IdentityService.doLogout(aId);
         break;
 
       case 'cancel':
         IdentityService.doCancel(aId);
         break;
 
+      case 'getIdentity':
+        IdentityService.doGetIdentity(aId, aMessage.assertion);
+        break;
+
+      case 'signIn':
+        IdentityService.doSignIn(aId, aMessage.assertion);
+        break;
+
+      case 'signOut':
+        IdentityService.doSignOut(aId);
+        break;
+
+      case 'accountExists':
+        IdentityService.doAccountExists(aId, aMessage.exists);
+        break;
+
+      case 'createAccount':
+        IdentityService.doCreateAccount(aId, aMessage.assertion);
+        break;
+
       default:
         logger.error('Unknown identity method: ' + aMessage.method);
         break;
     }
   },
- 
+
   cleanUp: function SignInToWebsiteUX_cleanUp(aId) {
     let context = this.contexts[aId];
     if (context) {
       if (context.hostFrame) {
         context.hostFrame.cleanUp();
       }
       if (context.iframe && context.iframe.parentNode) {
         context.iframe.parentNode.removeChild(context.iframe);
         delete context.iframe;
       }
       this.contexts[aId] = {};
       delete this.contexts[aId];
     }
   },
- 
+
   delegate: function SignInToWebsiteUX_delegate(aOptions) {
     let hostFrame = new HostFrame();
     hostFrame.getIframe(aOptions, function() {
       // iframe has been added to aOptions
 
       // callback for the pipe when flow is complete
       aOptions.onComplete = function pipe_onComplete() {
         logger.log("pipe clean up now");
@@ -422,33 +487,70 @@ this.SignInToWebsiteUX = {
       // store context and communicate with pipe
       this.contexts[aOptions.id] = aOptions;
       this.contexts[aOptions.id].hostFrame = hostFrame;
 
       let pipe = new this.PipeConstructor(aOptions, this);
       pipe.communicate();
     }.bind(this));
   },
- 
+
   doWatch: function SignInToWebsiteUX_doWatch(aOptions) {
     aOptions.message = 'identity-delegate-watch';
     aOptions.src = kHiddenPersonaIframe;
     aOptions.showUI = false;
     logger.log("options:", aOptions);
     this.delegate(aOptions);
   },
- 
+
   doRequest: function SignInToWebsiteUX_doRequest(aOptions) {
     aOptions.message = 'identity-delegate-request';
     aOptions.src = kInteractivePersonaIframe;
     aOptions.showUI = true;
     logger.log("options:", aOptions);
     this.delegate(aOptions);
   },
 
   doLogout: function SignInToWebsiteUX_doLogout(aOptions) {
     aOptions.message = 'identity-delegate-logout';
     aOptions.src = kHiddenPersonaIframe;
     aOptions.showUI = false;
     logger.log("options:", aOptions);
     this.delegate(aOptions);
+  },
+
+  doGetIdentity: function SignInToWebsiteUX_doGetIdentity(aOptions) {
+    logger.log("delegating getIdentity:" , aOptions);
+    aOptions.message = 'identity-delegate-getIdentity';
+    aOptions.src = kHiddenPersonaIframe;
+    aOptions.showUI = false;
+    this.delegate(aOptions);
+  },
+
+  doSignIn: function SignInToWebsiteUX_doSignIn(aOptions) {
+    logger.log("delegating signin:" , aOptions);
+    aOptions.message = 'identity-delegate-signIn';
+    aOptions.src = kHiddenPersonaIframe;
+    aOptions.showUI = false;
+    this.delegate(aOptions);
+  },
+
+  doSignOut: function SignInToWebsiteUX_doSignOut(aOptions) {
+    aOptions.message = 'identity-delegate-signOut';
+    aOptions.src = kHiddenPersonaIframe;
+    aOptions.showUI = false;
+    this.delegate(aOptions);
+  },
+
+  doAccountExists: function SignInToWebsiteUX_doSignOut(aOptions) {
+    aOptions.message = 'identity-delegate-accountExists';
+    aOptions.src = kHiddenPersonaIframe;
+    aOptions.showUI = false;
+    this.delegate(aOptions);
+  },
+
+  doCreateAccount: function SignInToWebsiteUX_doCreateAccount(aOptions) {
+    aOptions.message = 'identity-delegate-createAccount';
+    aOptions.src = kHiddenPersonaIframe;
+    aOptions.showUI = false;
+    this.delegate(aOptions);
   }
 };
diff --git a/dom/identity/tests/head_identity.js b/dom/identity/tests/head_identity.js
--- a/dom/identity/tests/head_identity.js
+++ b/dom/identity/tests/head_identity.js
@@ -38,16 +38,28 @@ function RequestListener() {
   Services.obs.addObserver(this, "http-on-modify-request", false);
   logger.log("Listening for http-on-modify-request");
 }
 
 RequestListener.prototype = {
   observe: function observe(aSubject, aTopic, aData) {
     if (aTopic === "http-on-modify-request") {
       logger.log("SpecialPowers.wrap(", aSubject, ").QueryInterface(Ci.nsIHttpChannel);");
+      // XXX [jedp] this blows up in the b2g test when pushing to try
+      // Error is:
+      //
+      // 15:51:04 INFO - 25778 ERROR TEST-UNEXPECTED-FAIL
+      // | /tests/dom/identity/tests/test_rp.html
+      // | uncaught exception - NS_ERROR_NOT_IMPLEMENTED:
+      //   Component returned failure code: 0x80004001 (NS_ERROR_NOT_IMPLEMENTED)
+      //   [nsIObserverService.addObserver] at chrome://specialpowers/content/specialpowersAPI.js:83
+      //
+      // XXX need to figure out if this is expected to behave differently on
+      // b2g, in which case the test needs to be rewritten or excluded from b2g
+      // builds.
       let channel = SpecialPowers.wrap(aSubject).QueryInterface(Ci.nsIHttpChannel);
       let ioservice = Cc["@mozilla.org/network/io-service;1"]
                         .getService(Ci.nsIIOService);
       let src = channel.URI.spec;
       let target = null;
       if (src.match(/include.js/)) target = MOCK_INCLUDEJS;
       if (src.match(/communication_iframe/)) target = MOCK_IFRAME;
       if (src.match(/sign_in/)) target = MOCK_DIALOG;
